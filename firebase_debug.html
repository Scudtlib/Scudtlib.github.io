<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Firebase Debug</title>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif;background:#f6f7fb;color:#222}
    .wrap{max-width:900px;margin:40px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.08)}
    h1{margin-top:0}
    code,pre{background:#0f172a;color:#e5e7eb;padding:12px;border-radius:8px;overflow:auto}
    .ok{color:#10b981}.warn{color:#f59e0b}.err{color:#ef4444}
    .row{margin:12px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Firebase 初始化除錯頁</h1>
    <p>這頁會逐步檢查 <code>config.js</code> 是否載入、內容是否可讀、Firebase 模組是否可被載入，以及初始化錯誤的原因。</p>
    <div id="log"></div>
  </div>

  <!-- 載入你的設定 -->
  <script src="./config.js"></script>

  <script type="module">
    const logEl = document.getElementById('log');
    const log = (html) => { const div = document.createElement('div'); div.className='row'; div.innerHTML = html; logEl.appendChild(div); };

    function safe(obj){ try { return JSON.stringify(obj, null, 2); } catch(e){ return String(obj); } }

    // 1) 確認全域變數存在
    log(`<div><b>使用者代理</b><pre>${navigator.userAgent}</pre></div>`);

    log(`<div><b>window.__firebase_config (string)</b><pre>${safe(window.__firebase_config)}</pre></div>`);
    log(`<div><b>window.__firebase_config_obj (object)</b><pre>${safe(window.__firebase_config_obj)}</pre></div>`);
    log(`<div><b>window.firebaseConfig (object)</b><pre>${safe(window.firebaseConfig)}</pre></div>`);
    log(`<div><b>window.__app_id</b> = <code>${safe(window.__app_id)}</code></div>`);

    // 2) 解析設定
    let cfg = null;
    try {
      if (window.firebaseConfig) cfg = window.firebaseConfig;
      else if (window.__firebase_config_obj) cfg = window.__firebase_config_obj;
      else if (window.__firebase_config) cfg = JSON.parse(window.__firebase_config);
      if (!cfg) throw new Error("無法取得 Firebase 設定（cfg 為空）");
      log(`<div class="ok">✅ 已取得設定：</div><pre>${safe(cfg)}</pre>`);
    } catch (e) {
      log(`<div class="err">❌ 設定解析失敗：${e.message}</div>`);
    }

    // 3) 嘗試載入模組
    let app = null;
    try {
      const appMod = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
      const authMod = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
      const fsMod = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
      log(`<div class="ok">✅ 成功載入 Firebase 模組。</div>`);

      // 4) 初始化
      const { initializeApp } = appMod;
      app = initializeApp(cfg);
      log(`<div class="ok">✅ initializeApp 成功。</div>`);

      // 5) 匿名登入
      const { getAuth, signInAnonymously } = authMod;
      const auth = getAuth(app);
      await signInAnonymously(auth);
      log(`<div class="ok">✅ 匿名登入成功。</div>`);

      // 6) 探測 Firestore 寫入權限（僅 getFirestore 不會寫入）
      const { getFirestore } = fsMod;
      const db = getFirestore(app);
      log(`<div class="ok">✅ getFirestore 成功。</div>`);
    } catch (e) {
      log(`<div class="err">❌ 錯誤：${e.message}</div><pre>${safe(e.stack)}</pre>`);
    }
  </script>
</body>
</html>
